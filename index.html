<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç†±é–€é¤å»³æœå°‹å™¨ (å·¦å³ä½ˆå±€ç‰ˆ)</title>
    <style>
        /* å…¨åŸŸè¨­å®š */
        body, html { height: 100%; margin: 0; font-family: 'Microsoft JhengHei', sans-serif; background: #f4f7f6; }
        .main-container {
            max-width: 1200px; margin: 0 auto; padding: 20px; height: calc(100vh - 40px); /* è®“é«˜åº¦å¡«æ»¿è¦–çª— */
            display: flex; flex-direction: column;
        }
        h2 { text-align: center; color: #333; margin: 0 0 15px 0; }

        /* æœå°‹å€å¡Š */
        .search-section {
            background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 15px; flex-shrink: 0; /* é˜²æ­¢æœå°‹æ¢è¢«å£“ç¸® */
        }
        .search-box { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        input:focus { border-color: #4285F4; }
        button { min-width: 80px; padding: 12px; font-size: 16px; background: #4285F4; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:hover { background: #3367D6; }
        #status { text-align: center; margin-top: 10px; font-size: 14px; color: #d32f2f; font-weight: bold; min-height: 20px; }
        .success-msg { color: #2e7d32 !important; }

        /* å…§å®¹å€å¡Š (å·¦åœ–å³åˆ—è¡¨) */
        .content-wrapper {
            flex: 1; /* å¡«æ»¿å‰©é¤˜ç©ºé–“ */
            display: flex;
            gap: 20px;
            min-height: 0; /* é‡è¦ï¼šè®“ flex å­å…ƒç´ å¯ä»¥æ­£ç¢ºæ»¾å‹• */
        }

        /* å·¦å´åœ°åœ–å®¹å™¨ */
        #map-container {
            flex: 6; /* ä½” 60% å¯¬åº¦ */
            background: #eee; border-radius: 12px; overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        #map { width: 100%; height: 100%; }

        /* å³å´åˆ—è¡¨å®¹å™¨ */
        #list-container {
            flex: 4; /* ä½” 40% å¯¬åº¦ */
            background: white; border-radius: 12px; overflow-y: auto; /* è®“åˆ—è¡¨å¯ä»¥å‚ç›´æ»¾å‹• */
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }
        
        /* åˆ—è¡¨æ¨£å¼ */
        ul { list-style: none; padding: 0; margin: 0; }
        li { 
            background: #fff; border-bottom: 1px solid #eee; padding: 15px; 
            display: flex; align-items: flex-start; gap: 15px; cursor: pointer; transition: 0.2s; 
        }
        li:hover { background: #f8f9fa; }
        
        .rank { 
            background: #999; color: white; width: 24px; height: 24px; 
            border-radius: 50%; text-align: center; line-height: 24px; font-size: 12px; flex-shrink: 0; margin-top: 2px;
        }
        .top-3 { background: #f44336; }

        .info { flex: 1; }
        .info h3 { margin: 0 0 5px; font-size: 16px; color: #202124; line-height: 1.4; }
        .info p { margin: 0; color: #5f6368; font-size: 13px; }
        .meta-tag {
            display: inline-block; background: #e8f0fe; color: #1967d2; 
            font-size: 12px; padding: 4px 8px; border-radius: 4px; margin-top: 8px;
        }

        /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼èª¿æ•´ï¼šè®Šå›ä¸Šä¸‹æ’åˆ— */
        @media (max-width: 768px) {
            .content-wrapper { flex-direction: column; }
            #map-container { flex: none; height: 300px; width: 100%; }
            #list-container { flex: 1; width: 100%; }
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="search-section">
        <h2>ğŸ”¥ ç†±é–€é¤å»³æœå°‹å™¨</h2>
        <div class="search-box">
            <input type="text" id="address" placeholder="è¼¸å…¥åœ°é» (ä¾‹: æ–°å…‰ä¸‰è¶Š, å°åŒ—è»Šç«™)">
            <button onclick="findLocation()">æœå°‹</button>
        </div>
        <div id="status">è«‹è¼¸å…¥åœ°é»é–‹å§‹æœå°‹</div>
    </div>

    <div class="content-wrapper">
        <div id="map-container">
            <div id="map"></div>
        </div>
        <div id="list-container">
            <ul id="list">
                <li style="color:#666; justify-content: center; padding: 30px;">
                    çµæœå°‡é¡¯ç¤ºæ–¼æ­¤
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ API Key ğŸ‘‡ğŸ‘‡ğŸ‘‡
    const MY_API_KEY = "AIzaSyB5WzhHwuf3uUEJ6iNQBovL7U07E2eGXAg"; 
</script>

<script>
    function loadScript() {
        if(!MY_API_KEY || MY_API_KEY.includes("åœ¨æ­¤è™•")) {
            alert("âš ï¸ è«‹æ‰“é–‹æª”æ¡ˆå¡«å…¥æ­£ç¢ºçš„ API Keyï¼"); return;
        }
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${MY_API_KEY}&libraries=places&language=zh-TW`;
        script.onload = initMap;
        document.head.appendChild(script);
    }

    let map, service, markers = [];

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 25.0330, lng: 121.5654 }, zoom: 14,
            mapTypeControl: false
        });
        service = new google.maps.places.PlacesService(map);
    }

    // æ¸…é™¤åœ°åœ–ä¸Šçš„æ¨™è¨˜
    function clearMarkers() {
        markers.forEach(m => m.setMap(null));
        markers = [];
    }

    function findLocation() {
        const query = document.getElementById('address').value;
        const status = document.getElementById('status');
        const list = document.getElementById('list');

        if(!query) return alert("è«‹è¼¸å…¥åœ°é»åç¨±ï¼");
        
        status.className = "";
        status.innerHTML = "ğŸ” æ­¥é©Ÿ 1/2: æ­£åœ¨æ¨¡ç³Šå®šä½åœ°é»...";
        list.innerHTML = '<li style="justify-content: center; padding: 30px;"><img src="https://i.gifer.com/ZZ5H.gif" width="30"> æœå°‹ä¸­...</li>';
        clearMarkers();

        console.log(`é–‹å§‹ TextSearch: ${query}`);

        // 1. æ¨¡ç³Šæœå°‹åœ°é»
        service.textSearch({ query: query }, (results, statusText) => {
            console.log(`TextSearch çµæœ: ${statusText}`, results);

            if (statusText === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                results.sort((a, b) => (b.user_ratings_total || 0) - (a.user_ratings_total || 0));
                const bestMatch = results[0];
                const location = bestMatch.geometry.location;

                status.className = "success-msg";
                status.innerHTML = `ğŸ“ å·²å®šä½ï¼š<b>${bestMatch.name}</b>ã€‚<br>ğŸ” æ­¥é©Ÿ 2/2: æ­£åœ¨æœå°‹ 3 å…¬é‡Œå…§ç†±é–€é¤å»³...`;
                
                map.setCenter(location);
                map.setZoom(15);
                markers.push(new google.maps.Marker({ 
                    map: map, position: location, title: "æœå°‹ä¸­å¿ƒ", 
                    icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' 
                }));

                // 2. æœå°‹é™„è¿‘é¤å»³
                searchNearbyRestaurants(location);

            } else {
                console.error("å®šä½å¤±æ•—:", statusText);
                status.className = "";
                status.innerText = `âŒ æ‰¾ä¸åˆ°åœ°é» "${query}"ã€‚éŒ¯èª¤ä»£ç¢¼: ${statusText}`;
                list.innerHTML = '<li style="justify-content: center; color: red;">å®šä½å¤±æ•—</li>';
            }
        });
    }

    function searchNearbyRestaurants(location) {
        const list = document.getElementById('list');
        const status = document.getElementById('status');

        console.log("é–‹å§‹ NearbySearch (radius: 3000, type: restaurant)");

        service.nearbySearch({
            location: location,
            radius: 3000,
            type: ['restaurant']
        }, (results, statusText) => {
            console.log(`NearbySearch çµæœ: ${statusText}`, results);

            // âš ï¸ é—œéµä¿®æ­£ï¼šé€™è£¡å¢åŠ äº†å° ZERO_RESULTS çš„åˆ¤æ–·ï¼Œé¿å…å¡ä½
            if (statusText === google.maps.places.PlacesServiceStatus.OK) {
                
                status.innerHTML = `âœ… æœå°‹å®Œæˆï¼æ‰¾åˆ° ${results.length} é–“é¤å»³ (å·²ä¾ç†±é–€åº¦æ’åº)`;
                list.innerHTML = ""; // æ¸…ç©ºåˆ—è¡¨

                // ä¾ç…§ã€Œè©•è«–æ•¸ã€æ’åº
                results.sort((a, b) => (b.user_ratings_total || 0) - (a.user_ratings_total || 0));

                results.forEach((place, index) => {
                    createListItem(place, index + 1);
                });

            } else if (statusText === 'ZERO_RESULTS') {
                status.className = "";
                status.innerText = "âš ï¸ é™„è¿‘ 3 å…¬é‡Œå…§æ‰¾ä¸åˆ°ä»»ä½•é¤å»³è³‡æ–™ã€‚";
                list.innerHTML = '<li style="justify-content: center; color: orange;">é™„è¿‘ç„¡é¤å»³</li>';
            } else {
                console.error("å‘¨é‚Šæœå°‹å¤±æ•—:", statusText);
                status.className = "";
                status.innerHTML = `âŒ å‘¨é‚Šæœå°‹å¤±æ•—ã€‚éŒ¯èª¤ä»£ç¢¼: <b>${statusText}</b><br>è«‹æŒ‰ F12 æŸ¥çœ‹ Console è©³ç´°è¨Šæ¯ã€‚`;
                list.innerHTML = `<li style="justify-content: center; color: red;">æœå°‹éŒ¯èª¤: ${statusText}</li>`;
            }
        });
    }

    function createListItem(place, rank) {
        const list = document.getElementById('list');
        const item = document.createElement('li');
        const reviews = place.user_ratings_total ? place.user_ratings_total : 0;
        const rating = place.rating ? place.rating.toFixed(1) : "N/A";
        const rankClass = rank <= 3 ? "rank top-3" : "rank";

        item.innerHTML = `
            <div class="${rankClass}">${rank}</div>
            <div class="info">
                <h3>${place.name} (${rating}â˜…)</h3>
                <p>${place.vicinity}</p>
                <div class="meta-tag">ğŸ”¥ ${reviews.toLocaleString()} å‰‡è©•è«–</div>
            </div>
        `;
        
        item.addEventListener('click', () => {
            map.setCenter(place.geometry.location);
            map.setZoom(17);
        });
        list.appendChild(item);

        // æ¨™è¨˜å‰ 20 ååœ¨åœ°åœ–ä¸Š
        if(rank <= 20) {
            const marker = new google.maps.Marker({
                map: map, position: place.geometry.location,
                label: { text: rank.toString(), color: "white", fontSize: "12px" },
                title: place.name, zIndex: 100 - rank
            });
            markers.push(marker);
            // é»æ“Šåœ°åœ–æ¨™è¨˜ä¹Ÿè§¸ç™¼åˆ—è¡¨é»æ“Šæ•ˆæœ
            marker.addListener('click', () => item.click());
        }
    }

    loadScript();
</script>

</body>
</html>
